

$OUUsuarios = "OU=Usuarios,DC=sistemaoperativo,DC=com"

$contrasenaInicialPlano = 'S00-usc0:.,'
# El siguiente comando convierte la contraseña en una cadena segura requerida por New-ADUser
$contrasenaSegura = ConvertTo-SecureString $contrasenaInicialPlano -AsPlainText -Force

# Obtiene el nombre DNS del dominio actual para construir el UPN
$dominioDNS = (Get-ADDomain).DNSRoot

# Nombres de los grupos (Asegúrate de que estos grupos existan en tu AD)
$groupRectoria = "Rectoria - GP"
$groupTH = "TH - GP"
$groupSoftware = "Software - GP"

# ============================

function Obtener-UltimoNumeroUsuario {
    # Filtra todos los usuarios cuyo SamAccountName comienza con "Usuario"
    $usuarios = Get-ADUser -Filter 'SamAccountName -like "Usuario*"' -SearchBase $OUUsuarios |
                Select-Object -ExpandProperty SamAccountName -ErrorAction SilentlyContinue

    if (-not $usuarios -or $usuarios.Count -eq 0) { return 0 }

    # Extrae el número del nombre (ej: Usuario50 -> 50)
    $numeros = foreach ($u in $usuarios) {
        if ($u -match "^Usuario(\d+)$") { [int]$matches[1] }
    }

    # Si hay números válidos, devuelve el número más alto encontrado.
    if ($numeros) {
        ($numeros | Measure-Object -Maximum).Maximum
    } else {
        return 0
    }
}

# Si Usuario01 ya existe, se asume que el lote inicial de 50 ya fue creado y se salta este paso.
# ============================

$numUsuariosIniciales = 50
$primerUsuarioNombre = "Usuario01"

# Validar si el primer usuario del lote inicial ya existe
$usuarioInicialExiste = Get-ADUser -Filter "SamAccountName -eq '$primerUsuarioNombre'" -ErrorAction SilentlyContinue

if ($usuarioInicialExiste) {
    # Si existe, arrojar el mensaje solicitado y pasar al bucle interactivo.
    Write-Host "--------------------------------------------------------" -ForegroundColor Yellow
    Write-Host "USUARIOS YA EXISTENTES: El lote inicial ($primerUsuarioNombre a Usuario$numUsuariosIniciales) " -ForegroundColor Red
    Write-Host "ya existe en el sistema. Se omite la creación inicial y se procede a la parte interactiva." -ForegroundColor Red
    Write-Host "--------------------------------------------------------" -ForegroundColor Yellow
}
else {
    # Si no existe, procedemos a crear específicamente el lote 1 a 50
    Write-Host "Iniciando la creación de $numUsuariosIniciales usuarios iniciales (Usuario01 a Usuario50)..." -ForegroundColor Green

    for ($i = 1; $i -le $numUsuariosIniciales; $i++) {

        # Formato de dos dígitos para los nombres iniciales (01, 02, ..., 50)
        $nuevoNumFormato = "{0:d2}" -f $i
        $username = "Usuario$nuevoNumFormato"
        $displayName = "Usuario $nuevoNumFormato"

        # Uso de ${} para garantizar que PowerShell interprete la variable correctamente
        Write-Host "Creando ${username}..."

        # Creación del usuario
        New-ADUser `
            -Name $displayName `
            -SamAccountName $username `
            -UserPrincipalName "$username@$dominioDNS" `
            -AccountPassword $contrasenaSegura `
            -Enabled $true `
            -Path $OUUsuarios `
            -ChangePasswordAtLogon $true -ErrorAction Stop

        # Asignación de grupo según el rango del índice $i
        if ($i -ge 1 -and $i -le 10) {
            Add-ADGroupMember -Identity $groupRectoria -Members $username -ErrorAction SilentlyContinue
            Write-Host "  -> Asignado a ${groupRectoria}"
        }
        elseif ($i -ge 11 -and $i -le 30) {
            Add-ADGroupMember -Identity $groupTH -Members $username -ErrorAction SilentlyContinue
            Write-Host "  -> Asignado a ${groupTH}"
        }
        else { # Del 31 al 50
            Add-ADGroupMember -Identity $groupSoftware -Members $username -ErrorAction SilentlyContinue
            Write-Host "  -> Asignado a ${groupSoftware}"
        }
    }

    Write-Host ""
    Write-Host "Primeros $numUsuariosIniciales usuarios creados correctamente." -ForegroundColor Green
}


# ============================

while ($true) {

    Write-Host ""
    $respuesta = Read-Host "¿Desea crear más usuarios automáticos? (si/no)"
    if ($respuesta -notin @("si","SI","Si","s","S")) {
        Write-Host "Proceso finalizado." -ForegroundColor Green
        break
    }

    $cantidad = Read-Host "¿Cuántos usuarios desea crear?"
    if (-not ($cantidad -as [int]) -or ([int]$cantidad -le 0)) {
        Write-Host "Valor inválido. Ingrese un número positivo." -ForegroundColor Red
        continue
    }

    $cantidad = [int]$cantidad

    Write-Host ""
    Write-Host "Seleccione el grupo para estos usuarios:"
    Write-Host "1 = Rectoria"
    Write-Host "2 = TH"
    Write-Host "3 = Software"
    Write-Host ""

    $opcionGrupo = Read-Host "Seleccione (1/2/3)"

    switch ($opcionGrupo) {
        "1" { $grupoSeleccionado = $groupRectoria }
        "2" { $grupoSeleccionado = $groupTH }
        "3" { $grupoSeleccionado = $groupSoftware }
        default {
            Write-Host "Opción inválida. Intente de nuevo." -ForegroundColor Red
            continue
        }
    }
    
    # Obtener el último número actual para empezar desde ahí
    $ultimo = Obtener-UltimoNumeroUsuario
    $usuariosCreados = 0

    Write-Host "Iniciando la creación de $cantidad nuevos usuarios a partir de la secuencia $($ultimo + 1)..." -ForegroundColor Cyan

    for ($x = 1; $x -le $cantidad; $x++) {

        # Incrementar el último número conocido
        $ultimo = $ultimo + 1
        
        # Corrección: El número se convierte a cadena directamente, evitando el error de formato 'd2'
        $nuevoNumFormato = "$ultimo"
        $username = "Usuario$nuevoNumFormato"

        $displayName = "Usuario $nuevoNumFormato"

        # Creación del usuario
        try {
             New-ADUser `
                -Name $displayName `
                -SamAccountName $username `
                -UserPrincipalName "$username@$dominioDNS" `
                -AccountPassword $contrasenaSegura `
                -Enabled $true `
                -Path $OUUsuarios `
                -ChangePasswordAtLogon $true -ErrorAction Stop

            # Asignación de grupo
            Add-ADGroupMember -Identity $grupoSeleccionado -Members $username -ErrorAction SilentlyContinue
            $usuariosCreados++
            # Corrección: Uso de ${} para evitar errores de ParserError
            Write-Host " -> Creado y asignado a ${grupoSeleccionado}: ${username} (Secuencia: ${ultimo})" -ForegroundColor DarkGray
        }
        catch {
           
            Write-Host "ERROR al crear el usuario ${username}: $($_.Exception.Message)" -ForegroundColor Red
            # Si la creación falla, retrocedemos el contador para evitar saltos en la secuencia.
            $ultimo = $ultimo - 1 
            break
        }
    }

    Write-Host "Usuarios adicionales creados correctamente: $usuariosCreados" -ForegroundColor Cyan
}
